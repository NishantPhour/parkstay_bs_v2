{% extends 'ps/base.html' %}
{% load static %}
{% load forms %}
{% block extra_css %}
    {{ block.super }}
    <style>
        #guest-dropdown{
            min-width:200px;
            padding: 5px;
        }
        #guest-dropdown li{
            padding: 5px;
        }
        .radio-title{
            font-weight: bold;
            font-size: 18px;

        }
        [v-cloak] {
            display: none;
        }
    </style>
    <link type="text/css" href="/static/ps/css/search_avail.css?ver={{ GIT_COMMIT_HASH }}" rel="stylesheet">
{% endblock %}
{% block content %}
{% if not booking %}
    <div class="container">
        <div class="row">
            <div class="col-lg-12"><div class="well">
                <h3>Your session has expired, or you have not yet selected a campsite to book.</h3>
                <p>Please visit the <a href="{{EXPLORE_PARKS_SEARCH}}">Explore Parks website</a> to start a new campground booking session.</p>
            </div></div>
        </div>
    </div>
{% elif request.user.is_authenticated is False %}
<div class="container">
   <div class='alert alert-danger'> Sorry you are not logged in,  please login to complete your booking. </div>
</div>

{% else %}
<div id="addBooking">

    <input type='hidden' value='disabled' id='site_queue_manager_active'>
    <form method="POST" name="addBookingForm" @submit.prevent="validate()" novalidate><div class="container">

    {% csrf_token %}

    <div class="container" style='z-index:1'>
            <div class="row">

                        <div class="col-md-12">
                            <p v-cloak>

                            {% verbatim %}
                                <b>Time left to complete booking {{ timeleft }}.</b>
                            {% endverbatim %}
                                <a class="btn btn-info" href="{% url 'public_abort_booking' %}?change=true">Change in-progress booking</a>
                                <a class="btn btn-warning" href="{% url 'public_abort_booking' %}">Cancel in-progress booking</a>
                            </p>
                            {% if show_errors %}
                            <div class="alert alert-danger">
                                <p>There were some problems with your submission:</p>
                                <ul>
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                                {% for field in form %}{% for error in field.errors %}
                                    <li><b>{{ field.label }}:</b> {{ error }}</li>
                                {% endfor %}{% endfor %}
                                {% for error in vehicles.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                                {% for vehicle in vehicles %}{% for field, error in vehicle.errors.items %}
                                    <li><b>Vehicle {{ forloop.counter }} ({{ field }}):</b> {{ error }}</li>
                                {% endfor %}{% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>


	                <div class="col-lg-12 ">

                 <div class="round-box col-12 px-3">
                         <div class="col-12">
                                <div class="row">
                                     <div class="col-sm-12">
                                         <h5>Where</h5>
                                     </div>
                                </div>
                         </div>
                         <div class="col-12">
                                <div class='row'>
                                     <div class="col-sm-12 col-md-6">
                                        <div class="col-sm-12 col-md-12">
                                                <div id='region-park-avail-selection-outer' class='form-control'>

                                                         <div class='selection-informbox'>
                                                                  <span >
                                                                      <i class='bi-geo-alt'></i>
                                                                  </span>
                                                                  <span id='region-park-selection-inner'>
									  {{ booking.campground.name }}, {{ booking.campground.park.name }} - {% if booking.campground.site_type == 2 %}{{ booking.first_campsite.type }}{% else %}{{ booking.first_campsite.name }} ({{ booking.first_campsite.type }}){% endif %}

                                                                  </span>
                                                         </div>
                                                 </div>
                                        </div>
                                    </div>
                                </div>
                         </div>
                  </div>



                 <div class="round-box col-12 px-3">
                         <div class="col-12">
                                <div class="col-sm-12 col-md-12">
                                 <h5>When</h5>
                                </div>
                         </div>
                         <div class="col-12">
                              <div class='row'>

                                   <div class="col-sm-12 col-md-6">
                                       <div class="col-sm-12 ">

                                           <div class="col-sm-12 ">
                                              <div id="when-date-range" class='form-control' style=" ">
                                                       <div class='selection-informbox'>
                                                           <i class='bi-calendar3' dclass="glyphicon glyphicon-calendar"></i>&nbsp;
						           <span id='when-dates'>Arrive: ({{  booking.arrival|date:"D" }}) {{ booking.arrival|date:"j M y" }} Depart: ({{  booking.departure|date:"D" }}) {{ booking.departure|date:"j M y" }} </span>
						           <span> (<span id='when-nights'>{{ cg.nights }}</span> nights)</span>
                                                       </div>

                                              </div>
                                           </div>
			              </div>
                                  </div>
                               </div>
			  </div>
                 </div>

                 <div class="round-box col-12 px-3">
                         <div class="col-12">
                                <div class="col-sm-12 col-md-12">
                                 <h5>Camper(s)</h5>
                                </div>
                         </div>
                         <div class="col-12">
                              <div class='row'>
                                   <div class="col-sm-12 col-md-6">
                                       <div class="col-sm-12 ">
                                           <div class="col-sm-12 ">
                                              <div id="when-date-range" class='form-control' style="">
                                                 <div class='selection-informbox'>
                                                     <i class='bi-people-fill' dclass="glyphicon glyphicon-calendar"></i>&nbsp;
						     <span> {{ cg.num_adult }} adult, {{ cg.num_concession }} concession, {{ cg.num_children }} child, {{ cg.num_infants }} Infant </span>
                                                 </div>
                                            </div>
                                         </div>
                                      </div>
                                   </div> 
                              </div>
                         </div>
                 </div>

                 <div class="round-box col-12 px-3">
                         <div class="col-12">
                                <div class="col-sm-12 col-md-12">
                                   <h5>Vehcile(s)</h5>
                                </div>
                         </div>
                         <div class="col-12">
                              <div class='row'>
                                   <div class="col-sm-12 col-md-6">
                                       <div class="col-sm-12 ">
                                           <div class="col-sm-12 ">
                                              <div id="when-date-range" class='form-control' style="">
                                                 <div class='selection-informbox'>
                                                     <i class='bi-people-fill' dclass="glyphicon glyphicon-calendar"></i>&nbsp;
						     <span > {{ booking.details.num_vehicle }} cars , {{ booking.details.num_campervan }} campervans, {{ booking.details.num_caravan }} caravan, {{ booking.details.num_motorcycle  }} motor cycles, {{ booking.details.num_trailer }} trailers </span>
                                                 </div>
                                            </div>
                                         </div>
                                      </div>
                                   </div>
                              </div>
                         </div>
                 </div>

                 <div class="round-box col-12 px-3">
                         <div class="col-12">
                                <div class="col-sm-12 col-md-12">
                                   <h5>Personal Details</h5>
                                </div>
                         </div>
                         <div class="col-12">
                              <div class="row">
                                  <div class="col-lg-6">
                                      <div class="well">
					  {% if request.user.is_staff %}
                                          <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
						  {{ form.email.label_tag }}
						  {{ form.email|class:'form-control' }}
                                                </div>
                                            </div>
                                            <div class="col-md-6" >
                                                <div class="form-group">
						    {{ form.confirm_email.label_tag }}
						    {{ form.confirm_email|class:'form-control' }}
                                                </div>
                                            </div>
                                          </div>
                                          <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                  {{form.first_name.label_tag}}
                                                  {{ form.first_name|class:'form-control'}}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{form.last_name.label_tag}}
                                                    {{ form.last_name|class:'form-control'}}
                                                </div>
                                            </div>
                                          </div>
                                          <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{form.postcode.label_tag}}
                                                    {{ form.postcode|class:'form-control'}}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{form.country.label_tag}}
                                                    {{ form.country|class:'form-control'}}
                                                </div>
                                            </div>
                                          </div>
                                          <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{form.phone.label_tag}}
                                                    {{ form.phone|class:'form-control'}}
                                                </div>
                                            </div>
                                          </div>
                                          {% else %}
                                            <div class="col-md-12">
                                                <p>Logged in as user <b>{{ request.user.email }}</b>.</p>
                                            </div>
                                          <div class="row" style='display:none'>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                  {{form.first_name.label_tag}}
                                                  {{ form.first_name|class:'form-control-hidden'}}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{form.last_name.label_tag}}
                                                    {{ form.last_name|class:'form-control'}}
                                                </div>
                                            </div>
                                          </div>
                                          <div class="row"  istyle='display:none'>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{form.postcode.label_tag}}
                                                    {{ form.postcode|class:'form-control'}}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{form.country.label_tag}}
                                                    {{ form.country|class:'form-control'}}
                                                </div>
                                            </div>
                                          </div>
                                          <div class="row"  istyle='display:none'>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{form.phone.label_tag}}
                                                    {{ form.phone|class:'form-control'}}
                                                </div>
                                            </div>
                                          </div>



                                          {% endif %}



                                      </div>


                                  </div>
                             </div>
                         </div>
                 </div>

                 <div class="round-box col-12 px-3">
                         <div class="col-12">
                                <div class='row'>
                                <div class="col-sm-6 col-md-6">
                                   <h5>Vehicle Details</h5>
                                </div>
                                <div class="col-sm-6 col-md-6 text-end">
                                        <a href="javascript:void(0);" class='btn btn-primary' v-on:click="open_vehicle_popup" >Update Vehicle</a>
                                </div>
                                </div>
                         </div>


                         <div class="col-12">
                                      <div class="row" style='font-weight:bold'> 
                                          <div class="col-md-2">
						Vehicle Type
					  </div>
                                          <div class="col-md-4">
						Vehicle Rego
					  </div>
                                          <div class="col-md-6">
						Pre-Pay Park Pass
					  </div>

                                       </div>
                                       <div class="row form-group" v-for="(vehicle, index) in vehicles">
                                          <div class="col-md-2">
                                                  <div >
                                                  <span v-if="vehicle[0] == 0">Vehicle<span>
                                                  </div>
                                                  <div >

                                                  <span v-if="vehicle[0] == 2">Motorcycle<span>
                                                  </div>
                                                   <div >

                                                  <span v-if="vehicle[0] == 3">Campervan<span>
                                                  </div>
                                                   <div >

                                                  <span v-if="vehicle[0] == 4">Trailer<span>
                                                  </div>
                                                  <div>
					          <span v-if="vehicle[0] == 5">Caravan<span>
						  </div>

                                          </div>
                                          <div class="col-md-4" >
						<div v-if="vehicle[1].length > 0" v-html="vehicle[1]">
						</div>
                                                <div v-else>
							<b style='color:red'>Please Add Rego Number</b>
						</div>
                                          </div>
                                          <div class="col-md-6">
                                              <div class="form-check form-switch" v-if="pricing.vehicle" vhtml="vehicle[2]">
						      <i v-if="vehicle[2]==true" style="color: #00f300" class="bi bi-check-circle-fill"></i>
						      <i v-if="vehicle[2]==false"  style="color: #f30000" class="bi bi-x-circle-fill"></i>
                                              </div>
                                          </div>
                                      </div>
			</div>
		</div>


               <div class="modal fade" id="VehicleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static" data-backdrop="static" data-keyboard="false">
                 <div class="modal-dialog modal-xl">
                   <div class="modal-content">
                     <div class="modal-header">
                       <h5 class="modal-title" id="exampleModalLabel">Vehicle</h5>
                       <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                     </div>
                     <div class="modal-body">
                       <div class="alert alert-danger" role="alert" id='vehicle-popup-error' style='display:none'></div>


                      <div class="round-box col-12 px-3">
                         <div class="col-12">
                                <div class="col-sm-12 col-md-12">
                                   <h5>Vehicle Details</h5>
                                </div>
                         </div>
                         <div class="col-12">
                              <div class="row">
                                      <div class="row" v-cloak style='display:none'>
                                          <div class="col-md-4">
                                              <div class="form-group">
                                                  <label>Number of vehicles:
                                                          <input class="form-control" name="form-TOTAL_FORMS" max="{{ campsite.max_vehicles }}" min="0" value="1" v-model="vehicleCount" v-on:change="updateVehicles" type="number"/><span id='max_vehicles_error' style='color:red;font-weight:bold;'></span>
                                                      <input id="id_form-INITIAL_FORMS" name="form-INITIAL_FORMS" type="hidden" value="1" />
                                                      <input id="id_form-MIN_NUM_FORMS" name="form-MIN_NUM_FORMS" type="hidden" value="0" />
                                                      <input id="id_form-MAX_NUM_FORMS" name="form-MAX_NUM_FORMS" type="hidden" value="{{ campsite.max_vehicles }}" />
                                                  </label>
                                              </div>
                                          </div>
                                      </div>



                                      <div class="row form-group" v-for="(vehicle, index) in vehicles">
                                          <div class="col-md-2">
						  <div >
						  <span v-if="vehicle[0] == 0">Vehicle<span> 
						  </div>
						  <div >

						  <span v-if="vehicle[0] == 2">Motorcycle<span>
                                                  </div>
                                                   <div >

						  <span v-if="vehicle[0] == 3">Campervan<span>
                                                  </div>
                                                   <div >

						  <span v-if="vehicle[0] == 4">Trailer<span>
						  </div>
                                                  <div>
                                                  <span v-if="vehicle[0] == 5">Caravan<span>
                                                  </div>

                                                  <input class="form-control" v-bind:name="'form-'+Number(index).toString()+'-vehicle_type'" type="hidden" placeholder="Vehicle Type" v-model="vehicle[0]" autocomplete="off"  />

                                          </div>
                                          <div class="col-md-4">
                                              <input class="form-control" v-bind:name="'form-'+Number(index).toString()+'-vehicle_rego'" type="text" placeholder="Registration" v-model="vehicle[1]"  v-on:change="updateLocalStorage" autocomplete="off" v-on-keyup="updateVehiclesFees"/>
                                          </div>

                                          <div class="col-md-3">
                                              <div class="form-check form-switch" v-if="pricing.vehicle">
                                                   <label class="form-check-label">
                                                   <input class="form-check-input" v-bind:name="'form-'+Number(index).toString()+'-entry_fee'" type="checkbox" v-model="vehicle[4]" v-on-click="updateVehiclesFees" checked/> Hire car</label>
                                              </div>
                                          </div>


                                          <div class="col-md-3">
                                              <div class="form-check form-switch" v-if="pricing.vehicle">
                                                   <label class="form-check-label">
                                                   <input class="form-check-input" v-bind:name="'form-'+Number(index).toString()+'-entry_fee'" type="checkbox" v-model="vehicle[2]" v-on-click="updateVehiclesFees" checked/> Pre-pay park entrance fee</label>
                                              </div>
                                          </div>
                                      </div>

			      </div>
                         </div>
                 </div>
        </div>

         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id='group-close-modal' data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary peak-group-create" v-on:click="updateVehiclesFees"  button-data='{"action": "create"}'>Save</button>
            <div class="spinner-border text-primary" role="status" style='display:none' id='peakgroup_progress_loader_create'>
                      <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% if request.user.is_staff is True %}
              {% if allow_price_override is True %} 

                 <div class="round-box col-12 px-3">
                         <div class="col-12">
				<div class='row'>
                                <div class="col-sm-6 col-md-6">
                                   <h5>Override Price</h5>
                                </div>
				<div class="col-sm-6 col-md-6 text-end">
					<a href="javascript:void(0);" class='btn btn-danger' v-on:click="open_booking_override" >Override Price</a>
				</div>
				</div>
                         </div>
                         <div class="col-12">
                              <div class='row'>
                                <div class="col-12">
				<br>
                                <h6>Campsite Fees</h6>
                                     <table width='100%'>
					     <tr><th>ID</th><th>Campsite</th><th>Date</th><th>Adult Amount</th><th>Child Amount</th><th>Infant Amount</th><th>Concession Amount</th></tr>
					<tbody id="override_price_campsites">
					     <tr><td></td><td></td><td></td></tr>
					</tbody>
				     </table>
				</div>
                                <div class="col-12">
                                     <br>
                                     <h6>Other Fees</h6>
                                     <table width='100%'>
                                        <tr><th>ID</th><th>Item</th><th>Amount</th></tr>
                                        <tbody id="override_price_other">
                                             <tr><td></td><td></td><td></td></tr>
                                        </tbody>
                                     </table>
                                </div>
                              </div>
                         </div>
                 </div>
             {% endif %}
         {% endif %}


                 <div class="round-box col-12 px-3">
                         <div class="col-12">
                                <div class="col-sm-12 col-md-12">
                                   <h5>Pricing</h5>
                                </div>
                         </div>
                         <div class="col-12">
                              <div class='row'>

                                   <div class="col-sm-12 col-md-6">
                                       <div class="col-sm-12 ">
                                          <div class="form-group">
                                            <label for="Total Price">Total Price <span class="text-muted">(GST inclusive.)</span></label>
                                            <div class="input-group">
                                              <span class="input-group-addon">AUD $</span>
                                              <input type="text" class="form-control" :value="total|formatMoney(2)" readonly="true">
                                              </div>
                                          </div>
                                      </div>
                                   </div>
                              </div>
                         </div>
                 </div>





        <div class="row">
            <div class="col-lg-12">
                <div class="well">
                    <div class="row">
                        <div class="col-md-12" style='display:none'>
                            <div class="row form-horizontal">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="col-sm-4 control-label pull-left required">{{ form.num_adult.label_tag }} </label>
                                        <div class="col-sm-8">
                                                {{ form.num_adult }}
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-4 control-label pull-left required">{{ form.num_concession.label_tag }} </label>
                                        <div class="col-sm-8">
                                                {{ form.num_concession }}
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-4 control-label pull-left required">{{ form.num_child.label_tag }} </label>
                                        <div class="col-sm-8">
                                                {{ form.num_child }}
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-4 control-label pull-left required">{{ form.num_infant.label_tag }} </label>
                                        <div class="col-sm-8">
                                                {{ form.num_infant }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12" v-cloak v-if="concessionWarning">

                         <div class="round-box col-12 px-3">
                                 <div class="col-12">
                                        <div class="col-sm-12 col-md-12">
                                           <h5>Concession Holders</h5>
                                        </div>
                                 </div>
                                 <div class="col-12">


                                                   Please note, only holders of the following Australian-issued cards are entitled to concessions:
                                                   <ul>
                                                       <li>Seniors Card</li>
                                                       <li>Age Pension</li>
                                                       <li>Disability Support</li>
                                                       <li>Carer Payment</li>
                                                       <li>Carer Allowance</li>
                                                       <li>Companion Card</li>
                                                       <li>Department of Veterans' Affairs</li>
                                                   </ul>
                                  </div>
                         </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>






        <div class="row">
            <div class="col-lg-12">
                <div class="well">
                    <div class="row">
                      <div class="col-md-6">
                         <div class="alert alert-danger" style='min-height: 250px'>
                            <div class="form-group">
                              <p style="">Changes not permitted. Cancel up to 29 days before arrival for 50% refund.  No exceptions for <a href='https://www.wa.gov.au/organisation/covid-communications/covid-19-coronavirus-controlled-interstate-border'>interstate and international travel restrictions</a>.  If you are planning to travel to Western Australia you are advised not to book before you have completed all entry and quarantine requirements.</p>
                            </div>
                          </div>
                      </div>

                        <div class="col-md-6 ">
                            <div class="row ">
                                <div class="col-md-12">
                                  <div class="alert alert-info" style='min-height: 250px'>

                                    <div class="checkbox">
                                        <label><input type="checkbox" v-bind:value="toc"   name='toc' v-model="toc">I agree to the <a target="_blank" href="https://exploreparks.dbca.wa.gov.au/know/online-camp-site-booking-terms-and-conditions">terms and conditions</a></label>
                                    </div>

                                    <div class="checkbox">
                                        <label><input type="checkbox" v-bind:value="outsideregion"  name='outsideregion' v-model="outsideregion">I understand that no exemption from standard refund conditions will apply for <a href='https://www.wa.gov.au/organisation/covid-communications/covid-19-coronavirus-controlled-interstate-border'>interstate and international travel restrictions</a>, and that those restrictions are subject to change.</label>

                                    </div>

                                    <div class="checkbox">
                                        <label><input type="checkbox" v-bind:value="trav_res"   name='trav_res' v-model="trav_res">I understand that hygiene facilities at Parks and Wildlife Service campgrounds are minimal.</label>
                                    </div>
                                    <br>

				    <button :disabled="!toc||!outsideregion||!trav_res" type="submit" class="btn btn-primary btn-lg">Proceed to payment </button>
                                    {% if request.user.is_staff is True %}
                                              {% if booking_without_payment is True %}

                                                    <label>&nbsp;&nbsp;<input type="checkbox" v-bind:value="no_payment"   name='no_payment' v-model="no_payment">&nbsp;&nbsp;Create Booking without Payment</label>
                                              {% endif %}
                                    {% endif %}
                                </div>
                               </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div></form>
    <div class="modal fade" id="OverridePriceModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Override Price</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-danger" role="alert" id='override-popup-error' style='display:none'>
    
            </div>
    
            <form id='override_price'>
    	    <div class='col-12'>
		   <br>
    	           <h6>Campsite Pricing</h6>
    	           <table width='100%'>
			   <tr><th>ID</th><th>Campsite</th><th>Date</th><th>Adult Amount</th><th>Child Amount</th><th>Infant Amount</th><th>Concession Amount</th></tr>
                               <tbody id='override_campsite_price_popup'>
    	           	<tr><td></td></tr>
    	           	</tbody>
    	           </table>
		   <br>
    	           <h6>Other Pricing</h6>
                       <table width='100%'>
                               <tr><th>ID</th><th>Item Name</th><th>Amount</th></tr>
                               <tbody id='override_other_price_popup'>
                               <tr><td></td></tr>
                               </tbody>
                       </table>
                </div>
                 <br><br>
                 <h6>Override Reason</h6>
                <div class='col-6'>
                 <div class='col-12'>
                <select class="form-control" name="override_reason_selection"><option value=""></option> 
		{% for o in override_reasons %}
                    <option value='{{ o.id }}'>{{ o.text }}</option>
		{% endfor %}
		</select>
               </div>
               <div class='col-12'>
                     <div class="form-group"><label class="control-label">Override reason detail:</label> <textarea id="override_reason_details" class="form-control"></textarea></div> 
                </div>
		<div class='col-12'>
	
                      <p class="muted" style="color: red; font-weight: bold;">
                           Note, these details will show on the customer invoice.
                      </p>
	        </div>
                 </br></br>
               </div>
    
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id='group-close-modal' data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary peak-group-create" v-on:click="save_price_override"  button-data='{"action": "create"}'>Save</button>
            <div class="spinner-border text-primary" role="status" style='display:none' id='peakgroup_progress_loader_create'>
                      <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

{% endif %}
</div>
{% endblock %}

{% block custom_js %}
  {{ block.super }}

{% if booking %}
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.0/moment.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/vue/2.2.4/vue.min.js"></script>
<script type="text/javascript">
    var book = new Vue({
        el: '#addBooking',
        data: {
	    csrf_token: '{{ csrf_token }}',
            expiry: moment('{{ expiry|escapejs }}'),
            timer: {{ timer }},
            get_booking_info_url: '/api/booking_pricing/',
            update_booking_url: '/api/booking_updates/',
            booking_data: {},
            pricing: {
                adult: {{ pricing.adult }},
                concession: {{ pricing.concession }},
                child: {{ pricing.child }},
                infant: {{ pricing.infant }},
                vehicle: {{ pricing.vehicle }},
                vehicleConc: {{ pricing.vehicle_conc }},
                motorcycle: {{ pricing.motorcycle }},
		campervan: {{ pricing.campervan }},
		trailer: {{ pricing.trailer }}
            },
            vehicles: [
            //    [0, '', true]
            ],
            vehicle_totals: {
		    vehicle: {{ booking.details.num_vehicle }},
		    campervan: {{ booking.details.num_campervan }},
		    motorcycle: {{ booking.details.num_motorcycle }},
		    trailer: {{ booking.details.num_trailer }},
		    caravan: {{ booking.details.num_caravan }}
	    },
	    price_override :{

	    },
	    price_override_admin: { 
	    },
            perDayFee: 0,
            entryFee: 0,
            total: 0,
            concessionWarning: false,
            vehicleCount: 1,
            toc: false,
            outsideregion: false,
            trav_res: false,
	    no_payment: false,
   	    max_vehicles: {% if campsite.max_vehicles > 0 %}{{ campsite.max_vehicles }}{% else %}0{% endif %},
            booking_id: {{ booking.id }}
        },
        filters:{
            formatMoney:function(n,c, d, t){
                c = isNaN(c = Math.abs(c)) ? 2 : c;
                d = d == undefined ? "." : d;
                t = t == undefined ? "," : t;
                var s = n < 0 ? "-" : "";
                var i = String(parseInt(n = Math.abs(Number(n) || 0).toFixed(c)));
                var j = (j = i.length) > 3 ? j % 3 : 0;
               return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
             }
        },
        computed: {
            timeleft: {
                cache: false,
                get: function get() {
                    // Minutes and seconds
                    var mins = ~~(this.timer / 60);
                    var secs = this.timer % 60;

                    // Hours, minutes and seconds
                    var hrs = ~~(this.timer / 3600);
                    var mins = ~~((this.timer % 3600) / 60);
                    var secs = this.timer % 60;

                    // Output like "1:01" or "4:03:59" or "123:03:59"
                    var ret = "";

                    if (hrs > 0) {
                        ret += "" + hrs + ":" + (mins < 10 ? "0" : "");
                    }

                    ret += "" + mins + ":" + (secs < 10 ? "0" : "");
                    ret += "" + secs;
                    return ret;
                }
            }
        },
        methods:{
            updateLocalStorage: function() {
                var vm = this;
                var data = {
                    booking: vm.booking_id,
                    vehicles: vm.vehicles
                }
                localStorage.setItem('checkoutVehicleData',JSON.stringify(data));
            },
            updateVehiclesFees: function () {
		     var vm = this;
 		     console.log(vm.vehicles);
                     vm.update_booking();
	             vm.calculateTotal();
            },
            updateVehicles: function () {
                console.log('updateVehicles');
                var vm = this;
                var diff = vm.vehicles.length - vm.vehicleCount;
	        $('#max_vehicles_error').html("");
            	//if ( vm.vehicleCount > vm.max_vehicles) {
		//    $('#max_vehicles_error').html("Error: Vehicle limit is "+vm.max_vehicles);
		//    vm.vehicleCount = vm.max_vehicles;
		//     diff = vm.vehicles.length - vm.vehicleCount;
		//}    	    

                for (var i=0; i<vm.vehicle_totals.vehicle; i++) {
			 vm.vehicles.push([0, '', true]);
	        }
                for (var c=0; c<vm.vehicle_totals.campervan; c++) {
			vm.vehicles.push([3, '', true]);
	        } 
		for (var i=0; i<vm.vehicle_totals.motorcycle; i++) {
                         vm.vehicles.push([2, '', true]);
                }
                for (var i=0; i<vm.vehicle_totals.trailer; i++) {
                         vm.vehicles.push([4, '', true]);
                }
                for (var c=0; c<vm.vehicle_totals.caravan; c++) {
	               vm.vehicles.push([5, '', true]);
	        } 

 		// vm.vehicleCount = vm.vehicle_totals.vehicle + vm.vehicle_totals.campervan + vm.vehicle_totals.motorcycle + vm.vehicle_totals.trailer;
                //     if (diff < 0) {
                //         for (var i=0; i<-diff; i++) {
                //             vm.vehicles.push([0, '', true]);
                //         }
                //     } else if (diff > 0) {
                //         for (var i=0; i<diff; i++) {
                //             vm.vehicles.pop();
                //         }
                //     }
                console.log(vm.vehicles);
                vm.calculateTotal();

                vm.updateLocalStorage();
            },
	    open_booking_override: function() {
		$('#OverridePriceModal').modal('show');
	    },
	    open_vehicle_popup: function() {
		$('#VehicleModal').modal('show');
	    },
	    save_price_override: function() {
	        var vm = this;
	        var post_data = {};
		$("form#override_price :input").each(function(){
			     var input = $(this); // This is the jquery object of the input, do what you will
	                     vm.price_override[input.attr("name")] = input.val();
	                     console.log(input.attr("name"));
	                     console.log(input.val());
		});

                vm.price_override_admin['override_reason_selection'] = $("select[name=override_reason_selection]").val();
	        vm.price_override_admin['override_reason_details'] = $("#override_reason_details").val(); 

	        console.log(vm.price_override);
	        vm.update_booking();
	    },
	    buildVehicleInfo: function() {
	        console.log("buildVehicleInfo");
	        console.log(this);
	        var vm = this;
		var vehicles=[];
                if (vm.booking_data.booking_vehicle) {
                     for (let c = 0; c < vm.booking_data.booking_vehicle.length; c++) {
			        var row = [];
	                        var vehicle_type = null;
	                        if (vm.booking_data.booking_vehicle[c].type == 'vehicle') {
                                      vehicle_type = 0;
	                        } 
	                        if (vm.booking_data.booking_vehicle[c].type == 'motorbike') {
                                       vehicle_type = 2;
	                        }

	                        if (vm.booking_data.booking_vehicle[c].type == 'campervan') {
                                       vehicle_type = 3;
	                        }
	                        if (vm.booking_data.booking_vehicle[c].type == 'trailer') {
                                       vehicle_type = 4;
	                        }
	                        if (vm.booking_data.booking_vehicle[c].type == 'caravan') {
                                       vehicle_type = 5;
	                        }
			        row[0] = vehicle_type;
			        row[1] = vm.booking_data.booking_vehicle[c].rego;
			        row[2] = vm.booking_data.booking_vehicle[c].entry_fee;
	                        row[3] = vm.booking_data.booking_vehicle[c].id
	                        row[4] = vm.booking_data.booking_vehicle[c].hire_car;
                                vehicles.push(row);
                     }
		     vm.vehicles = vehicles;
                }
	    },
            get_booking_pricing: function() { 
                console.log("get_booking_pricing");
                var vm = this; 
                $.ajax({
                    url: vm.get_booking_info_url,
                    method: 'GET',
                    dataType: 'json',
                    contentType: 'application/json',
                    // data: "{}",
                    success: function (response) {
                          vm.booking_data = response;
	                  vm.calculateTotal();
			  vm.buildPricingTable();
                          vm.buildVehicleInfo();
                          console.log(vm.booking_data);
                    },
                    error: function (error) {
                        console.log('Error loading booking data');
                    },
                });
            },
            update_booking: function() {
                console.log("update booking");
	        $('#vehicle-popup-error').hide();
	        $('#vehicle-popup-error').html('');
		$('#override-popup-error').hide();
		$('#override-popup-error').html('');

                var vm = this;
                var post_data = {'vehicles': vm.vehicles, 'price_override': vm.price_override, 'price_override_admin' : vm.price_override_admin, 'no_payment': vm.no_payment}
                $.ajax({
                    url: vm.update_booking_url,
                    method: 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    headers: {'X-CSRFToken' : vm.csrf_token },
                    data: JSON.stringify({'payload': post_data}),
                    success: function (response) {
                          vm.booking_data = response;
                          vm.get_booking_pricing();
			  $('#VehicleModal').modal('hide');
			  $('#OverridePriceModal').modal('hide');
                    },
                    error: function (error) {
			var error_message = "There was unknown error.";
			if (error.hasOwnProperty('responseJSON') ) { 
                              if (error.responseJSON.hasOwnProperty('msg') ) {
                                   if (error.responseJSON.msg.hasOwnProperty('error')) {
                                        error_message = error.responseJSON.msg.error;
			           }
			      }

		        }
	                $('#vehicle-popup-error').html(error_message); 
	                $('#vehicle-popup-error').show();
			$('#override-popup-error').html(error_message);
			$('#override-popup-error').show();
                        console.log('Error loading booking data');
		        
                    },
                });
            },
	    buildPricingTable: function() {
	        var vm = this;
	        console.log("buildPricingTable");
	        var campsite_pricing_html = "";
		var campsite_override_price_popup_html = "";
		var other_override_price_popup_html = "";
                for (let c = 0; c < vm.booking_data.campsite_booking.length; c++) {
                        campsite_pricing_html+= "<TR><TD>"+vm.booking_data.campsite_booking[c].id+"</TD><TD>"+vm.booking_data.campsite_booking[c].item_name+"</TD>";
			campsite_pricing_html+= "<TD>"+vm.booking_data.campsite_booking[c].date+"</TD>";
			campsite_pricing_html+= "<TD>$"+vm.booking_data.campsite_booking[c].amount_adult+"</TD>";
                        campsite_pricing_html+= "<TD>$"+vm.booking_data.campsite_booking[c].amount_child+"</TD>";
			campsite_pricing_html+= "<TD>$"+vm.booking_data.campsite_booking[c].amount_infant+"</TD>";
			campsite_pricing_html+= "<TD>$"+vm.booking_data.campsite_booking[c].amount_concession+"</TD>";
			campsite_pricing_html+= "</TR>";

			campsite_override_price_popup_html+= "<TR><TD>"+vm.booking_data.campsite_booking[c].id+"</TD>";
			campsite_override_price_popup_html+= "<TD>"+vm.booking_data.campsite_booking[c].item_name+"</TD>";
			campsite_override_price_popup_html+= "<TD>"+vm.booking_data.campsite_booking[c].date+"</TD>";
			campsite_override_price_popup_html+= "<TD><div class='input-group input-group-sm' style='width:130px'><span class='input-group-text'>$</span><input type='text' class='form-control input-sm money' aria-label='Amount (to the nearest dollar)'  value='"+vm.booking_data.campsite_booking[c].amount_adult+"' name='price-override-campsites-adult-"+vm.booking_data.campsite_booking[c].id+"' ></div></TD>";
			 campsite_override_price_popup_html+= "<TD><div class='input-group input-group-sm' style='width:130px'><span class='input-group-text'>$</span><input type='text' class='form-control input-sm money' aria-label='Amount (to the nearest dollar)'  value='"+vm.booking_data.campsite_booking[c].amount_child+"' name='price-override-campsites-child-"+vm.booking_data.campsite_booking[c].id+"' ></div></TD>";
			 campsite_override_price_popup_html+= "<TD><div class='input-group input-group-sm' style='width:130px'><span class='input-group-text'>$</span><input type='text' class='form-control input-sm money' aria-label='Amount (to the nearest dollar)'  value='"+vm.booking_data.campsite_booking[c].amount_infant+"' name='price-override-campsites-infant-"+vm.booking_data.campsite_booking[c].id+"' ></div></TD>";
			 campsite_override_price_popup_html+= "<TD><div class='input-group input-group-sm' style='width:130px'><span class='input-group-text'>$</span><input type='text' class='form-control input-sm money' aria-label='Amount (to the nearest dollar)'  value='"+vm.booking_data.campsite_booking[c].amount_concession+"' name='price-override-campsites-concession-"+vm.booking_data.campsite_booking[c].id+"' ></div></TD>";
			 campsite_override_price_popup_html+= "</TR>";
		}
	        var other_pricing_html = "";
		var other_override_price_popup_html = "";
                for (let c = 0; c < vm.booking_data.additional_booking.length; c++) {
                           other_pricing_html+= "<TR><TD>"+vm.booking_data.additional_booking[c].id+"</TD><TD>"+vm.booking_data.additional_booking[c].item_name+"</TD><TD>$"+vm.booking_data.additional_booking[c].amount+"</TD></TR>";
			 other_override_price_popup_html+="<TR><TD>"+vm.booking_data.additional_booking[c].id+"</TD><TD>"+vm.booking_data.additional_booking[c].item_name+"</TD><TD><div class='input-group input-group-sm' style='width:130px'><span class='input-group-text'>$</span><input type='text' class='form-control input-sm money' aria-label='Amount (to the nearest dollar)'  value='"+vm.booking_data.additional_booking[c].amount+"'  name='price-override-other-"+vm.booking_data.additional_booking[c].id+"' ></TD></TR>";
                 // override_price_other 
		}
                $('#override_price_campsites').html(campsite_pricing_html);
                $('#override_price_other').html(other_pricing_html);
               
		$('#override_campsite_price_popup').html(campsite_override_price_popup_html);
		$('#override_other_price_popup').html(other_override_price_popup_html);
	    },
            calculateTotal: function () {
                var vm = this;
                // vm.get_booking_pricing();
                var form = document.forms.addBookingForm;

	        vm.entryFee = 0;
                vm.total = 0;
		if ( vm.booking_data ) {
		   if (vm.booking_data.campsite_booking) {
	               for (let c = 0; c < vm.booking_data.campsite_booking.length; c++) {
	                          console.log(vm.total);
                                  vm.total += parseFloat(vm.booking_data.campsite_booking[c].amount_adult); 
			          vm.total += parseFloat(vm.booking_data.campsite_booking[c].amount_child);
			          vm.total += parseFloat(vm.booking_data.campsite_booking[c].amount_infant);
			          vm.total += parseFloat(vm.booking_data.campsite_booking[c].amount_concession);
	               }
		   }
		   if (vm.booking_data.additional_booking) {
                      for (let c = 0; c < vm.booking_data.additional_booking.length; c++) {
		      	vm.total += parseFloat(vm.booking_data.additional_booking[c].amount);
	              }
		   }

                   if (vm.booking_data.old_campsite_booking) {
                       for (let c = 0; c < vm.booking_data.old_campsite_booking.length; c++) {
                                  console.log(vm.total);
                                  vm.total -= parseFloat(vm.booking_data.old_campsite_booking[c].amount_adult);
                                  vm.total -= parseFloat(vm.booking_data.old_campsite_booking[c].amount_child);
                                  vm.total -= parseFloat(vm.booking_data.old_campsite_booking[c].amount_infant);
                                  vm.total -= parseFloat(vm.booking_data.old_campsite_booking[c].amount_concession);
                       }
                   }
                   if (vm.booking_data.old_additional_booking) {
                      for (let c = 0; c < vm.booking_data.old_additional_booking.length; c++) {
                        vm.total -= parseFloat(vm.booking_data.old_additional_booking[c].amount);
                      }
                   }


		}
                // add per-person fees
                // vm.total += (parseInt(form.num_adult.value) || 0)*vm.pricing.adult;
                // vm.total += (parseInt(form.num_concession.value) || 0)*vm.pricing.concession;
                // vm.total += (parseInt(form.num_child.value) || 0)*vm.pricing.child;
                // vm.total += (parseInt(form.num_infant.value) || 0)*vm.pricing.infant;

                // generate per night rate the ugly way
                // (price can vary based on date, so this is an approximate measure)
                // vm.perDayFee = vm.total/{{ booking.num_days }};

                // generate + add park entry fees
                //vm.vehicles.forEach(function (el) {
                //    if (el[2]) {
                //        switch(el[0]) {
                //            case '1':
                //                vm.entryFee += vm.pricing.vehicleConc;
                //                break;
                //            case '2':
                //                vm.entryFee += vm.pricing.motorcycle;
                //                break;
                //            case '3':
                //                vm.entryFee += vm.pricing.campervan;
                //                break;
                //            case '4':
                //                vm.entryFee += vm.pricing.trailer;
                //                break;
                //            case '0':
                //            default:
                //                vm.entryFee += vm.pricing.vehicle;
                //                break;
                //        }
                //    }
                //});
                //vm.total += vm.entryFee;

                // show concession warning text if the number > 0
                vm.concessionWarning = (parseInt(form.num_concession.value) > 0);
                return;
            },
            validate: function (e) {
                var isValid = true;
                var form = document.forms.addBookingForm;
                var fields = $(form).find(':input');
                // $('.tooltip-err').tooltip("destroy");
                $.each(fields, function(i, field) {
                    $(field).removeClass('tooltip-err');
                    $(field).closest('.form-group').removeClass('has-error');
                    if ($(field).attr('required') == 'required' || $(field).attr('required') == 'true') {
                        var inputStr = $(field).val();
                        if (inputStr == "" || inputStr == null) {
                             var errMsg = $(field).attr('data-error-msg') ? $(field).attr('data-error-msg') : "Field is required";
                             $(field).closest('.form-group').addClass('has-error');
                               $(field).focus();
                               $(field).select();
                               $(field).addClass('tooltip-err');
                               $(field).tooltip()
                                   .attr("data-original-title", errMsg)
                             isValid = false;
                         }
                    }
                });
                if (isValid) {
                    form.submit();
                }
            }
        },
        mounted: function () {
            var vm = this;
            vm.get_booking_pricing();
	    console.log(vm.vehicle_totals);
	    vm.vehicleCount = vm.vehicle_totals.vehicle + vm.vehicle_totals.campervan + vm.vehicle_totals.motorcycle + vm.vehicle_totals.trailer;
	    console.log("vm.vehicleCount");
	    console.log(vm.vehicleCount);
            vm.updateVehicles();
            // check that expiry is in a sane range
            var saneTz = (0 < Math.floor((vm.expiry - moment.now())/1000) < vm.timer);

            // update the countdown timer every second
            var timer = setInterval(function (ev) {
                // fall back to the pre-encoded timer
                if (!saneTz) {
                    vm.timer -= 1;
                } else {
                    // if the timezone is sane, do live updates
                    // this way unloaded tabs won't cache the wrong time.
                    var newTimer = Math.floor((vm.expiry - moment.now())/1000);
                    vm.timer = newTimer;
                }

                if ((vm.timer <= 0)) {
                    clearInterval(timer);
                    var loc = window.location;
                    window.location = loc.protocol + '//' + loc.host + loc.pathname;
                }
            }, 1000);

            // wire up events to the form controls
            // TODO: for django 1.11 replace python form controls with templates;
            // should be easier to inject vue stuff
            var cbCalc = function (ev) {
                vm.calculateTotal();
            };

            document.forms.addBookingForm.num_adult.addEventListener('change', cbCalc);
            document.forms.addBookingForm.num_concession.addEventListener('change', cbCalc);
            document.forms.addBookingForm.num_child.addEventListener('change', cbCalc);
            document.forms.addBookingForm.num_infant.addEventListener('change', cbCalc);

            // update the vehicle data from local storage
            var storedData = localStorage.getItem('checkoutVehicleData');
            if (storedData){
                try{
                    storedData = JSON.parse(storedData);
                    if (storedData.hasOwnProperty('booking') && storedData.hasOwnProperty('vehicles') && parseInt(storedData.booking) == parseInt(vm.booking_id)){
                        if (Array.isArray(storedData.vehicles)){
                            var length = storedData.vehicles.length;
                            vm.vehicles = [];
                            $.each(storedData.vehicles, function(i,v) {
                                vm.vehicles.push(v);
                            });
                            vm.vehicleCount = length;
                        }
                    }
                    else{
                        localStorage.removeItem('checkoutVehicleData');
                    }
                }
                catch(e){
                }
            }
            vm.calculateTotal();
        }
    });
</script>
{% endif %}
{% endblock %}
